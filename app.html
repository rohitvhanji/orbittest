
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orbit | Precision Scheduling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root {
            /* --- POLISHED SAAS THEME --- */
            --bg-body: #F8FAFC;       
            --bg-surface: #FFFFFF;    
            --border-subtle: #E2E8F0; 
            
            --text-main: #0F172A;     
            --text-muted: #64748B;    
            
            --accent-primary: #6366F1; /* Indigo */
            --accent-secondary: #10B981; /* Emerald */
            
            /* Legacy Mappings */
            --slack-purple: var(--accent-primary);
            --slack-green: var(--accent-secondary);
            --slack-blue: #3B82F6;
            --slack-navy: var(--text-main);
            --slack-bg: var(--bg-body);
            --slack-border: var(--border-subtle);
            --text-dark: var(--text-main);
            
            --status-lunch: #F59E0B;
            --status-snooze: #E2E8F0; 
            --status-weekend: #94A3B8;
            --night-wash: rgba(15, 23, 42, 0.85);
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); overflow: hidden; }

        /* --- LAYOUT --- */
        #app-shell { display: flex; height: 100%; width: 100%; }

        /* --- SIDEBAR --- */
        #sidebar { 
            width: 320px; 
            background: var(--bg-surface); 
            display: flex; flex-direction: column; flex-shrink: 0; 
            border-right: 1px solid var(--border-subtle);
            z-index: 30;
            box-shadow: 4px 0 24px rgba(0,0,0,0.02); 
        }
        
        .sidebar-header { 
            padding: 20px; 
            background: var(--bg-surface); 
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; 
        }
        .sidebar-header h2 { 
            margin: 0; font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; 
            color: var(--text-main); 
        }
        
        .mgmt-section { padding: 12px 20px; border-bottom: 1px solid var(--border-subtle); }
        
        .mgmt-input { 
            width: 100%; padding: 10px 12px; border-radius: 8px; 
            border: 1px solid transparent; 
            margin-bottom: 8px; box-sizing: border-box; 
            background: #F1F5F9; color: var(--text-main); 
            font-size: 0.85rem; font-weight: 500; transition: 0.2s;
        }
        .mgmt-input:focus { outline: none; background: white; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .mgmt-input::placeholder { color: #94A3B8; }

        .btn-main { 
            width: 100%; border: none; padding: 10px; border-radius: 8px; 
            font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: 0.2s; 
            letter-spacing: 0.5px; text-transform: uppercase;
        }
        .btn-login { background: var(--text-main); color: white; } 
        .btn-signup { background: white; color: var(--text-main); border: 1px solid var(--border-subtle); } 
        .btn-main:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        #member-groups { overflow-y: auto; flex-grow: 1; padding: 15px 20px; display: flex; flex-direction: column; gap: 12px; }

        .timezone-group { background: white; border: 1px solid var(--border-subtle); border-radius: 10px; overflow: hidden; }
        .tz-header { 
            padding: 8px 12px; font-size: 0.7rem; font-weight: 700; 
            background: #F8FAFC; color: var(--text-muted); 
            text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-subtle);
        }
        .location-card { border-bottom: 1px solid var(--border-subtle); }
        .location-card:last-child { border-bottom: none; }
        .loc-header { padding: 6px 12px 2px; font-size: 0.8rem; font-weight: 700; color: var(--text-main); display: flex; justify-content: space-between; }
        .member-row { padding: 2px 12px 6px; font-size: 0.8rem; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .btn-hover-del { cursor: pointer; color: #EF4444; opacity: 0; transition: 0.2s; margin-left: 10px; font-size: 1rem; }
        .tz-header:hover .btn-hover-del, .loc-header:hover .btn-hover-del, .member-row:hover .btn-hover-del { opacity: 1; }

        /* --- MAIN AREA --- */
        #main-view-container { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; background: var(--bg-body); }

        /* Map */
        #map-area { 
            flex-grow: 1; position: relative; overflow: hidden; display: none; 
            background: #475569; 
        } 
        #map-bg { 
            width: 100%; height: 100%; 
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/8/83/Equirectangular_projection_SW.jpg'); 
            background-size: cover; 
            opacity: 0.8; 
            filter: invert(1) hue-rotate(200deg) saturate(0.6) brightness(1.5) contrast(1.1); 
        }
        #svg-map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Grid View */
        #rec-view { display: flex; flex-grow: 1; flex-direction: column; height: 100%; overflow: hidden; padding: 0; }

        .fixed-header-group { 
            padding: 15px 30px 5px; 
            background: var(--bg-body); 
            flex-shrink: 0; 
            z-index: 20; 
            box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); 
        }
        .chart-header-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
        .chart-header-row h2 { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin: 0; letter-spacing: -0.5px; }
        .chart-header-row span { color: var(--text-muted); font-weight: 500; font-size: 0.85rem; }

        .chart-controls { display: flex; align-items: center; gap: 10px; }
        .chart-legend { display: flex; gap: 10px; font-size: 0.7rem; font-weight: 600; background: white; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border-subtle); color: var(--text-muted); box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-right: 5px; }
        .legend-box { width: 8px; height: 8px; border-radius: 2px; }

        .filter-bar { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 5px; }
        .filter-pill { 
            padding: 4px 10px; border-radius: 15px; font-size: 0.7rem; font-weight: 600; 
            cursor: pointer; border: 1px solid var(--border-subtle); transition: 0.2s; 
            background: white; color: var(--text-muted); 
        }
        .filter-pill:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .filter-pill.active { background: var(--text-main); color: white; border-color: var(--text-main); }
        .filter-pill.inactive { opacity: 0.5; background: transparent; }

        .scrollable-body { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            padding: 5px 30px 80px; 
        }
        .chart-centered-content { max-width: 1400px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; height: 100%; }

        .timezone-row-container { margin-bottom: 6px; }
        .chart-label { width: 180px; flex-shrink: 0; padding-right: 15px; display: flex; flex-direction: column; justify-content: center; }
        .chart-label span { font-size: 0.8rem; font-weight: 700; color: var(--text-main); }

        .pref-group { display: flex; gap: 3px; margin-top: 2px; }
        .pref-pill { font-size: 0.6rem; padding: 1px 6px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-subtle); background: white; color: var(--text-muted); transition: 0.2s; }
        .pref-pill:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .pref-pill.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        .pref-pill.global-active { background: var(--accent-secondary); color: white; border-color: var(--accent-secondary); }

        .chart-row { display: flex; align-items: center; }
        .chart-grid { flex-grow: 1; display: flex; gap: 3px; }
        
        .chart-box { 
            flex: 1; height: 26px; border-radius: 4px; 
            background: #F1F5F9; 
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem; transition: 0.2s; 
        }
        
        .time-tick { flex: 1; font-size: 0.6rem; text-align: center; color: var(--text-muted); font-weight: 600; margin-bottom: 2px; }
        .local-time-row { display: flex; margin-left: 180px; gap: 3px; }

        .match-row { margin-top: 15px; padding-top: 10px; border-top: 1px dashed var(--border-subtle); position: relative; }
        .match-row::before { content: "SUGGESTIONS"; position: absolute; top: -8px; left: 0; font-size: 0.6rem; font-weight: 800; color: var(--accent-secondary); letter-spacing: 1px; background: var(--bg-body); padding-right: 10px; }
        .match-row .chart-box { cursor: pointer; }
        .match-row .chart-box:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .highlight-slot { border: 2px solid var(--accent-primary) !important; z-index: 10; transform: scale(1.05); }

        /* CARDS AREA (Moved Up) */
        #rec-area-wrapper { 
            margin-top: 10px; 
            padding-top: 10px; 
            display: flex; 
            gap: 20px; 
            align-items: flex-start; 
            flex-shrink: 0; 
        }
        
        .section-header { font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        
        .rec-column-left { flex-grow: 1; display: flex; flex-direction: column; }
        
        /* FIX: Align Left & Right Columns + Fix Cutoff */
        /* Both left (reco) and right (selected) containers get same padding/layout props */
        #rec-results, #selected-results { 
            display: flex; 
            gap: 15px; 
            /* Top padding prevents hover card from being clipped by overflow:auto */
            padding: 10px 5px 20px 5px; 
        }
        #rec-results { overflow-x: auto; }
        #selected-results { flex-direction: column; }

        .rec-column-right { flex-shrink: 0; width: 300px; padding-left: 20px; border-left: 1px solid var(--border-subtle); display: flex; flex-direction: column; }

        /* FIX: Increased Height to 320px to prevent clipping of button */
        .rec-card { 
            width: 280px; 
            height: 320px; /* Taller height */
            flex-shrink: 0; 
            background: white; 
            border: 1px solid var(--border-subtle); border-radius: 16px; padding: 16px; 
            transition: 0.3s; position: relative; cursor: pointer; display: flex; flex-direction: column; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }
        .rec-card:hover { transform: translateY(-3px); border-color: var(--accent-primary); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05); }
        
        .rec-tag { position: absolute; top: 12px; right: 12px; font-size: 0.6rem; font-weight: 800; padding: 3px 8px; border-radius: 12px; }
        
        .tag-green { background: #D1FAE5; color: #047857; border: 1px solid #A7F3D0; }
        .tag-yellow { background: #FEF3C7; color: #B45309; border: 1px solid #FDE68A; }

        .rec-time-main { font-size: 1.1rem; font-weight: 800; color: var(--text-main); margin-bottom: 2px; display: flex; align-items: center; gap: 6px; letter-spacing: -0.5px; }
        .rec-reason { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; font-style: italic; }
        .rec-date-sub { font-size: 0.75rem; color: var(--text-main); margin-bottom: 8px; font-weight: 600; }
        
        .rec-list { 
            display: flex; flex-direction: column; gap: 4px; 
            overflow-y: hidden; 
            flex-grow: 1; 
            border-top: 1px solid var(--border-subtle); padding-top: 8px; 
        }
        .rec-row { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); }
        .rec-row span:last-child { font-weight: 600; color: var(--text-main); }

        .selected-card-style { border: 2px solid var(--accent-primary); background: #EEF2FF; }

        /* Floating Scheduler */
        #scheduler { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            padding: 6px 6px 6px 20px; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            border: 1px solid white; 
            border-radius: 40px; 
            display: flex; gap: 15px; align-items: center; justify-content: center; 
            z-index: 1000; box-shadow: 0 15px 30px -5px rgba(0,0,0,0.1), 0 0 0 1px rgba(0,0,0,0.05); 
        }

        .sched-group { display: flex; flex-direction: column; gap: 0px; }
        .sched-desc { font-size: 0.6rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-left: 4px; }

        #scheduler input, #scheduler select { 
            background: #F1F5F9; border: 1px solid transparent; 
            color: var(--text-main); border-radius: 8px; padding: 6px 10px; 
            outline: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.85rem;
        }
        #scheduler input:focus, #scheduler select:focus { background: white; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }

        #scheduler button { 
            height: 38px; padding: 0 20px; border-radius: 30px; border: none; 
            background: var(--text-main); color: white; 
            font-weight: 700; cursor: pointer; box-shadow: 0 5px 10px -3px rgba(0,0,0,0.1); transition: 0.2s; font-size: 0.85rem;
        }
        #scheduler button:hover { transform: scale(1.03); background: var(--accent-primary); }

        .map-floating-btn { 
            position: absolute; top: 20px; right: 20px; padding: 10px 20px; 
            background: white; color: var(--text-main); border: 1px solid var(--border-subtle); 
            border-radius: 10px; font-weight: 700; cursor: pointer; z-index: 100; transition: 0.2s; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); font-size: 0.8rem;
        }
        .map-floating-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        #city-modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); z-index: 3000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 450px; max-height: 80vh; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .modal-header { padding: 20px; background: white; color: var(--text-main); font-weight: 800; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-subtle); }
        .modal-body { padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .city-option { padding: 15px; border-radius: 12px; cursor: pointer; transition: 0.2s; text-align: left; display: flex; flex-direction: column; gap: 2px; }
        .city-option:hover { background: #F8FAFC; color: var(--accent-primary); }

        #share-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: white; padding: 12px 30px; border-radius: 40px; font-weight: 600; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); z-index: 5000; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        #share-toast.show { opacity: 1; top: 40px; }
        
        .map-label-text { font-size: 10px; font-weight: 900; fill: white; stroke: #020617; stroke-width: 3px; paint-order: stroke; }
        .grid-line { stroke: rgba(255,255,255,0.2); stroke-width: 1px; stroke-dasharray: 4; }
    </style>
</head>
<body>

<div id="share-toast"><span>üîó Link Copied to Clipboard!</span></div>

<div id="city-modal" style="display:none;"><div class="modal-content"><div class="modal-header"><span>Select Location</span><span onclick="closeModal()" style="cursor:pointer; color:#94A3B8;">‚úï</span></div><div class="modal-body" id="modal-list"></div></div></div>

<div id="app-shell">
    <aside id="sidebar">
        <div class="sidebar-header"><h2>ORBIT</h2><span id="logout-btn" onclick="logout()" style="cursor:pointer; font-size:0.75rem; color:var(--text-muted); font-weight:600;">Logout</span></div>
        <div class="mgmt-section"><input type="text" id="cityInput" class="mgmt-input" placeholder="City name..."><button id="addCityBtn" class="btn-main btn-login" onclick="lookupCity()">ADD OFFICE</button></div>
        <div class="mgmt-section"><input type="text" id="newName" class="mgmt-input" placeholder="Teammate Name..."><select id="newLoc" class="mgmt-input" style="appearance:none;"></select><button class="btn-main btn-signup" onclick="addMember()">ADD TEAMMATE</button></div>
        <div id="member-groups"></div>
    </aside>

    <main id="main-view-container">
        <div id="map-area"><div id="map-bg"></div><svg id="svg-map" viewBox="0 0 800 400" preserveAspectRatio="none"><g id="day-night-layer"></g><g id="grid-lines-layer"></g><g id="grid-label-layer"></g><g id="marker-layer"></g></svg><button class="map-floating-btn" onclick="toggleView('rec')">üìä Grid View</button></div>
        
        <div id="rec-view">
            <div class="fixed-header-group"><div class="chart-centered-content"><div class="chart-header-row"><div><h2>Team Overlap</h2><span>Visualizing global availability</span></div><div class="chart-controls"><div class="chart-legend"><div class="legend-item"><div class="legend-box" style="background:var(--accent-secondary)"></div> Match</div><div class="legend-item"><div class="legend-box" style="background:var(--status-lunch)"></div> Ask</div><div class="legend-item"><div class="legend-box" style="background:var(--status-weekend)"></div> Sleep</div></div><button onclick="shareDashboard()" style="padding:10px 20px; background:white; color:var(--text-main); border:1px solid var(--border-subtle); border-radius:12px; cursor:pointer; font-weight:700; transition:0.2s;">Share</button><button onclick="toggleView('map')" style="padding:10px 20px; background:var(--text-main); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:700;">World Map</button></div></div><div id="tz-filter-bar" class="filter-bar"></div></div></div>
            <div class="scrollable-body"><div class="chart-centered-content"><div id="chart-body"></div><div id="rec-area-wrapper"><div class="rec-column-left"><div class="section-header">‚ú® Best Windows</div><div id="rec-results"></div></div><div class="rec-column-right" id="selected-section" style="display:none;"><div class="section-header" style="color:var(--accent-primary);">üéØ Selected Time</div><div id="selected-results"></div></div></div></div></div>
        </div>

        <footer id="scheduler">
            <div class="sched-group"><span class="sched-desc">Date</span><input type="date" id="schedDate" onchange="setFitMode(true)"></div>
            <div class="sched-group"><span class="sched-desc">Zone</span><select id="inputTz" onchange="buildMatchChart()"></select></div>
            <div class="sched-group"><span class="sched-desc">Time</span><div style="display:flex; gap:5px;"><input type="number" id="hourVal" placeholder="HH" min="0" max="23" onchange="setFitMode(true)"><select id="minVal" onchange="setFitMode(true)"><option value="00">00</option><option value="30">30</option></select></div></div>
            <div class="sched-group"><span class="sched-desc">Length</span><select id="durVal" onchange="buildMatchChart()"><option value="30">30m</option><option value="60">1h</option><option value="90">1.5h</option></select></div>
            <button onclick="resetToLive()">
                Live
            </button>
        </footer>
    </main>
</div>

<script>
    if (typeof CONFIG === 'undefined') { window.CONFIG = { SUPABASE_URL: 'https://xcdnyheqtagizlcyzuzb.supabase.co', SUPABASE_KEY: 'sb_publishable_5cH3NNSKN1knnkm6ZMvggw_6RQdq9Nh', TIMEZONEDB_KEY: 'VW4CCUCGOI2M' }; }
    const _supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

    const DEFAULT_LOCATIONS = [{ name: 'Bengaluru', code: 'BLR', lat: 12.97, lon: 77.59, utc_offset: 5.5, tz: 'IST' },{ name: 'New York', code: 'NYC', lat: 40.71, lon: -74.00, utc_offset: -5, tz: 'EST' },{ name: 'Chicago', code: 'CHI', lat: 41.87, lon: -87.62, utc_offset: -6, tz: 'CST' },{ name: 'San Francisco', code: 'SFO', lat: 37.77, lon: -122.41, utc_offset: -8, tz: 'PST' }];
    const DEFAULT_TEAM = [{ id: 'g1', name: 'Ravi', location_name: 'Bengaluru' },{ id: 'g2', name: 'Sarah', location_name: 'New York' },{ id: 'g3', name: 'Mike', location_name: 'Chicago' },{ id: 'g4', name: 'Chen', location_name: 'San Francisco' }];

    let locationData = {}; let team = []; let isFitMode = false; let isMatchViewActive = true; let workDateUTC_MS = Date.now(); let chartExclusions = new Set(); let tzPreferences = {}; let manualSelectionSlot = null; let isGuestMode = false;

    async function checkSession() { 
        const params = new URLSearchParams(window.location.search); 
        if(params.has('share')) { loadSharedState(params.get('share')); return; } 
        const { data: { session } } = await _supabase.auth.getSession(); 
        if (session) { 
            isGuestMode = false; 
            document.getElementById('logout-btn').innerText = "Logout"; 
            loadData(); 
        } else {
            enableGuestMode(); // Auto-enable guest
        }
    }
    
    function enableGuestMode() { 
        isGuestMode = true; 
        document.getElementById('logout-btn').innerText = "‚òÅÔ∏è Guest"; 
        loadData(); 
    }
    
    async function logout() { 
        if(!isGuestMode) { await _supabase.auth.signOut(); }
        window.location.href = isGuestMode ? 'auth.html' : 'index.html'; 
    }

    function shareDashboard() { const payload = { d: document.getElementById('schedDate').value, dur: document.getElementById('durVal').value, ref: document.getElementById('inputTz').value, locs: locationData, team: team, pref: Array.from(Object.entries(tzPreferences)).map(([k, v]) => [k, Array.from(v)]) }; const url = `${window.location.origin}${window.location.pathname}?share=${encodeURIComponent(JSON.stringify(payload))}`; navigator.clipboard.writeText(url).then(() => { const t = document.getElementById('share-toast'); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }); }
    function loadSharedState(encodedStr) { try { const data = JSON.parse(decodeURIComponent(encodedStr)); isGuestMode = true; locationData = data.locs || {}; team = data.team || []; if(data.pref) { data.pref.forEach(([k, v]) => tzPreferences[k] = new Set(v)); } document.getElementById('schedDate').value = data.d; document.getElementById('durVal').value = data.dur; populateLocDropdown(); populateTzDropdown(); render(); buildMatchChart(); if(data.ref) document.getElementById('inputTz').value = data.ref; } catch(e) { enableGuestMode(); } }

    async function loadData() {
        try {
            let locs = [], members = [];
            if(isGuestMode) { const local = localStorage.getItem('orbit_guest_data'); if(local) { const p = JSON.parse(local); locs = p.locations; members = p.team; } else { locs = DEFAULT_LOCATIONS; members = DEFAULT_TEAM; }
            locationData = {}; locs.forEach(l => { const v = (l.utc_offset !== undefined) ? l.utc_offset : l.offset; locationData[l.name] = { code: l.code, offset: v, tz: l.tz, lon: l.lon, lat: l.lat, name: l.name }; tzPreferences[`${l.tz}_${v}`] = new Set(); });
            team = members.map(m => ({ id: m.id, name: m.name, loc: m.location_name || m.loc }));
            } else { const { data: { user } } = await _supabase.auth.getUser(); if (!user) return; const { data: dbLocs } = await _supabase.from('locations').select('*'); locs = dbLocs && dbLocs.length ? dbLocs : DEFAULT_LOCATIONS.map(d => ({...d, user_id: user.id})); if(!dbLocs || !dbLocs.length) await _supabase.from('locations').insert(locs); const { data: dbMems } = await _supabase.from('teammates').select('*'); members = dbMems || []; locationData = {}; locs.forEach(l => { const v = (l.utc_offset !== undefined) ? l.utc_offset : l.offset; locationData[l.name] = { code: l.code, offset: v, tz: l.tz, lon: parseFloat(l.lon), lat: parseFloat(l.lat), name: l.name }; tzPreferences[`${l.tz}_${v}`] = new Set(); }); team = members.map(m => ({ id: m.id, name: m.name, loc: m.location_name })); }
            populateLocDropdown(); populateTzDropdown(); render(); buildMatchChart();
        } catch(e) { console.error(e); }
    }

    function populateTzDropdown() { 
        const sel = document.getElementById('inputTz'); 
        const cur = sel.value; 
        const browserOffset = -new Date().getTimezoneOffset()/60;
        sel.innerHTML = ''; 
        const unique = {}; 
        Object.values(locationData).forEach(l => { unique[`${l.tz}_${l.offset}`] = { label: l.tz, offset: l.offset }; }); 
        let matchFound = false;
        let defaultVal = null;
        const sortedOptions = Object.values(unique).sort((a,b) => b.offset - a.offset);
        sortedOptions.forEach((u, index) => { 
            const opt = document.createElement('option'); 
            opt.value = u.offset; 
            opt.textContent = u.label; 
            sel.appendChild(opt); 
            if (index === 0) defaultVal = u.offset; 
            if (u.offset === browserOffset) { defaultVal = u.offset; matchFound = true; }
        }); 
        if(cur && Array.from(sel.options).some(o => o.value === cur)) { sel.value = cur; } else if (defaultVal !== null) { sel.value = defaultVal; }
    }

    async function lookupCity() { const input = document.getElementById('cityInput').value.trim(); if (!input) return; document.getElementById('addCityBtn').innerText = "‚è≥"; try { const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}`).then(r => r.json()); if (geo && geo.length > 0) confirmAndAddCity(geo[0]); } catch (e) {} document.getElementById('addCityBtn').innerText = "ADD OFFICE"; }
    async function confirmAndAddCity(geo) { try { const tzR = await fetch(`https://api.timezonedb.com/v2.1/get-time-zone?key=${CONFIG.TIMEZONEDB_KEY}&format=json&by=position&lat=${geo.lat}&lng=${geo.lon}`).then(r => r.json()); if(tzR.status === 'OK') { const n = { name: geo.display_name.split(',')[0], code: geo.display_name.substring(0,3).toUpperCase(), lon: parseFloat(geo.lon), lat: parseFloat(geo.lat), utc_offset: tzR.gmtOffset / 3600, tz: tzR.abbreviation }; if(isGuestMode) { locationData[n.name] = { ...n, offset: n.utc_offset }; tzPreferences[`${n.tz}_${n.utc_offset}`] = new Set(); localStorage.setItem('orbit_guest_data', JSON.stringify({ locations: Object.values(locationData), team: team })); populateLocDropdown(); populateTzDropdown(); render(); if(isMatchViewActive) buildMatchChart(); } else { const { data: { user } } = await _supabase.auth.getUser(); await _supabase.from('locations').upsert({ ...n, user_id: user.id }); loadData(); } } } catch(e) {} }
    async function addMember() { const n = document.getElementById('newName').value.trim(), l = document.getElementById('newLoc').value; if (!n || !l) return; if(isGuestMode) { team.push({ id: 'g' + Date.now(), name: n, loc: l }); localStorage.setItem('orbit_guest_data', JSON.stringify({ locations: Object.values(locationData), team: team })); render(); if(isMatchViewActive) buildMatchChart(); } else { const { data: { user } } = await _supabase.auth.getUser(); await _supabase.from('teammates').insert([{ name: n, location_name: l, user_id: user.id }]); loadData(); } document.getElementById('newName').value = ''; }
    async function removeLocation(n) { if(confirm(`Delete ${n}?`)) { if(isGuestMode) { delete locationData[n]; team = team.filter(m => m.loc !== n); localStorage.setItem('orbit_guest_data', JSON.stringify({ locations: Object.values(locationData), team: team })); populateLocDropdown(); populateTzDropdown(); render(); if(isMatchViewActive) buildMatchChart(); } else { await _supabase.from('locations').delete().eq('name', n); loadData(); } } }
    async function removeMember(id) { if(isGuestMode) { team = team.filter(m => m.id !== id); localStorage.setItem('orbit_guest_data', JSON.stringify({ locations: Object.values(locationData), team: team })); render(); if(isMatchViewActive) buildMatchChart(); } else { await _supabase.from('teammates').delete().eq('id', id); loadData(); } }
    function populateLocDropdown() { const sel = document.getElementById('newLoc'); sel.innerHTML = ''; Object.keys(locationData).sort().forEach(l => { const opt = document.createElement('option'); opt.value = l; opt.textContent = l; sel.appendChild(opt); }); }
    function togglePreference(key, type) { if (!tzPreferences[key]) tzPreferences[key] = new Set(); const prefs = tzPreferences[key]; if (type === 'global') { if (prefs.has('global')) prefs.delete('global'); else { prefs.clear(); prefs.add('global'); } } else { if (prefs.has('global')) prefs.delete('global'); if (prefs.has(type)) prefs.delete(type); else prefs.add(type); } buildMatchChart(); }
    function getStatus(utcMS, tV) { const d = new Date(utcMS); if (d.getUTCDay() === 0 || d.getUTCDay() === 6) return { color: "var(--status-weekend)", emoji: "üèñÔ∏è", isRed: true }; if (tV >= 22.5 || tV < 7) return { color: "var(--status-snooze)", emoji: "üò¥", isRed: true }; if (tV >= 12 && tV < 13.5) return { color: "var(--status-lunch)", emoji: "üçΩÔ∏è", isRed: false }; if (tV >= 9 && tV < 17) return { color: "var(--slack-green)", emoji: "üíª", isRed: false }; return { color: "var(--slack-blue)", emoji: "üè†", isRed: false }; }
    function toggleView(v) { isMatchViewActive = (v === 'rec'); document.getElementById('map-area').style.display = v === 'map' ? 'block' : 'none'; document.getElementById('rec-view').style.display = v === 'rec' ? 'flex' : 'none'; if(v === 'rec') buildMatchChart(); else drawMap(isFitMode ? workDateUTC_MS : Date.now()); }

    function evaluateMatch(sU, aO, dM, aL) {
        const active = [...new Set(Object.values(locationData).map(l => `${l.tz}_${l.offset}`))].filter(k => !chartExclusions.has(k));
        if(!active.length) return { color: "var(--status-weekend)", isRed: true };
        let redFound = false, greenCount = 0;
        for (const key of active) {
            const loc = Object.values(locationData).find(l => `${l.tz}_${l.offset}` === key);
            const dL = new Date(sU + (loc.offset * 3600000)), tV = dL.getUTCHours() + (dL.getUTCMinutes()/60), prefs = tzPreferences[key] || new Set();
            let isUG = false, isUR = false;
            if (dL.getUTCDay() === 0 || dL.getUTCDay() === 6) isUR = true;
            else if (prefs.has('global')) { if (tV >= 6 && tV < 24) isUG = true; else isUR = true; } 
            else { if (tV >= 22.5 || tV < 7) isUR = true; if (!isUR) { if ((tV >= 9 && tV < 12) || (tV >= 13.5 && tV < 17)) isUG = true; if (prefs.has('early') && tV >= 7 && tV < 9) isUG = true; if (prefs.has('night') && tV >= 17 && tV < 22.5) isUG = true; } }
            if (isUR) { redFound = true; break; } if (isUG) greenCount++;
        }
        if (redFound) return { color: "var(--status-snooze)", isRed: true, totalScore: -9999, reason: "Offline teams" };
        const isG = (greenCount === active.length); return { color: isG ? "var(--slack-green)" : "var(--status-lunch)", isRed: false, isGreen: isG, totalScore: isG ? 1000 : 500, reason: isG ? "‚úÖ Everyone online" : "‚≠ê Team flex" };
    }

    function renderTile(s, c, iS) {
        const card = document.createElement('div'); card.className = iS ? 'rec-card selected-card-style' : 'rec-card'; if (!iS) card.onclick = () => syncAndRender(s.utc); 
        const rV = document.getElementById('inputTz').value, dM = parseInt(document.getElementById('durVal').value); let sD, eD; if(rV === 'local') { sD = new Date(s.utc); eD = new Date(s.utc + (dM * 60000)); } else { const o = parseFloat(rV) * 3600000; sD = new Date(s.utc + o); eD = new Date(s.utc + o + (dM * 60000)); }
        const fT = (d) => rV === 'local' ? `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}` : `${d.getUTCHours()}:${d.getUTCMinutes().toString().padStart(2,'0')}`;
        const fD = (d) => rV === 'local' ? d.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'}) : d.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric', timeZone:'UTC'});
        let aB = iS ? `<a href="https://www.google.com/calendar/render?action=TEMPLATE&text=Orbit%20Team%20Sync&dates=${new Date(s.utc).toISOString().replace(/-|:|\.\d\d\d/g, "")}/${new Date(s.utc + (dM * 60000)).toISOString().replace(/-|:|\.\d\d\d/g, "")}" target="_blank" style="display:block; margin-top:15px; text-align:center; padding:12px; background:var(--slack-purple); color:white; text-decoration:none; border-radius:12px; font-weight:700; font-size:0.9rem;">üìÖ Schedule Meet</a>` : "";
        card.innerHTML = `<span class="rec-tag ${s.isGreen?'tag-green':'tag-yellow'}">${s.isGreen?'MATCH':'ASK'}</span><div class="rec-time-main"><span>${s.isGreen?'üü¢':'üü°'}</span> ${fT(sD)} ‚Äì ${fT(eD)}</div><div class="rec-reason">${s.reason}</div><div class="rec-date-sub">${fD(sD)}</div><div class="rec-list"></div>${aB}`;
        const active = [...new Set(Object.values(locationData).map(l => `${l.tz}_${l.offset}`))].filter(k => !chartExclusions.has(k));
        active.forEach(key => { const loc = Object.values(locationData).find(l => `${l.tz}_${l.offset}` === key); const ltS = new Date(s.utc + (loc.offset * 3600000)), ltE = new Date(s.utc + (loc.offset * 3600000) + (dM * 60000)); card.querySelector('.rec-list').innerHTML += `<div class="rec-row"><span>${loc.tz}</span><span>${fT(ltS)} ‚Äì ${fT(ltE)}</span></div>`; }); c.appendChild(card);
    }

    function buildMatchChart() {
        if (!isMatchViewActive) return; const dS = document.getElementById('schedDate').value; if(!dS) return; const body = document.getElementById('chart-body'); body.innerHTML = '';
        const groups = {}; Object.values(locationData).forEach(l => { const key = `${l.tz}_${l.offset}`; if (!groups[key]) groups[key] = l; }); const aGK = Object.keys(groups).sort((a,b) => groups[b].offset - groups[a].offset);
        const fBar = document.getElementById('tz-filter-bar'); fBar.innerHTML = ''; aGK.forEach(key => { const l = groups[key], isO = chartExclusions.has(key), btn = document.createElement('div'); btn.className = isO ? 'filter-pill inactive' : 'filter-pill active'; btn.innerText = (isO ? '‚óã ' : '‚óâ ') + l.tz; btn.onclick = () => { if(chartExclusions.has(key)) chartExclusions.delete(key); else chartExclusions.add(key); buildMatchChart(); }; fBar.appendChild(btn); });
        const dV = document.getElementById('durVal').value, dM = parseInt(dV); let count = 24, sMs = 60 * 60000; if(dV === "30") { count = 48; sMs = 30 * 60000; } if(dV === "90") { count = 16; sMs = 90 * 60000; }
        const rV = document.getElementById('inputTz').value; let sUTC = (rV === 'local') ? new Date(dS + "T00:00:00").getTime() : new Date(dS + "T00:00:00Z").getTime() - (parseFloat(rV) * 3600000); allProcessedSlots = [];
        aGK.forEach(key => {
            if (chartExclusions.has(key)) return; const loc = groups[key], prefs = tzPreferences[key] || new Set();
            let rowH = `<div class="timezone-row-container"><div class="local-time-row">`;
            for(let i=0; i<count; i++){ const slot = sUTC + (i * sMs), lD = new Date(slot + (loc.offset * 3600000)); let h = lD.getUTCHours(); let dP = (h === 0 && lD.getUTCMinutes() === 0) ? `<span style="color:var(--slack-purple); font-weight:900; font-size:0.6rem;">${lD.toLocaleDateString('en-US', { weekday: 'short', timeZone:'UTC' })}</span>` : h; rowH += `<div class="time-tick">${dP}</div>`; }
            rowH += `</div><div class="chart-row"><div class="chart-label"><span>${loc.tz}</span><div class="pref-group"><div class="pref-pill ${prefs.has('early')?'active':''}" onclick="togglePreference('${key}', 'early')">üåÖ</div><div class="pref-pill ${prefs.has('night')?'active':''}" onclick="togglePreference('${key}', 'night')">ü¶â</div><div class="pref-pill ${prefs.has('global')?'global-active':''}" onclick="togglePreference('${key}', 'global')">üåç</div></div></div><div class="chart-grid">`;
            for(let i=0; i<count; i++){ const slot = sUTC + (i * sMs), lD = new Date(slot + (loc.offset * 3600000)), h = lD.getUTCHours() + (lD.getUTCMinutes()/60), s = getStatus(slot + (loc.offset * 3600000), h); let isG = false; if (lD.getUTCDay() !== 0 && lD.getUTCDay() !== 6) { if(prefs.has('global')) { if(h>=6 && h<24) isG = true; } else { if(!(h>=22.5 || h<7)) { if((h>=9 && h<12)||(h>=13.5 && h<17)) isG = true; if(prefs.has('early') && h>=7 && h<9) isG = true; if(prefs.has('night') && h>=17 && h<22.5) isG = true; } } } 
            
            // UPDATED GRID BOX COLORS (Brighter)
            const bgColor = isG ? '#D1FAE5' : (s.isRed ? '#F1F5F9' : '#FEF3C7');
            const textColor = isG ? '#047857' : (s.isRed ? '#94A3B8' : '#B45309');
            
            rowH += `<div class="chart-box ${isFitMode && workDateUTC_MS === slot ? 'highlight-slot' : ''}" style="background:${bgColor}; color:${textColor};">${isG ? 'üíª' : s.emoji}</div>`; }
            rowH += `</div></div></div>`;
            body.innerHTML += rowH;
        });
        body.innerHTML += `<div class="chart-row match-row"><div class="chart-label">MATCH</div><div class="chart-grid" id="m-grid"></div></div>`;
        const g = document.getElementById('m-grid');
        for(let i=0; i<count; i++){ const slot = sUTC + (i * sMs), data = evaluateMatch(slot, parseFloat(rV==='local'?-1*(new Date().getTimezoneOffset()/60):rV), dM, "Team"); allProcessedSlots.push({ utc: slot, ...data }); const box = document.createElement('div'); box.className = 'chart-box'; if (isFitMode && workDateUTC_MS === slot) box.classList.add('highlight-slot'); box.style.background = data.color; box.onclick = () => syncAndRender(slot); g.appendChild(box); }
        const rc = document.getElementById('rec-results'); rc.innerHTML = ''; allProcessedSlots.filter(r => !r.isRed).sort((a,b) => b.totalScore - a.totalScore || a.utc - b.utc).slice(0, 3).forEach(s => renderTile(s, rc, false));
        const sc = document.getElementById('selected-results'), sw = document.getElementById('selected-section'); sc.innerHTML = ''; if (isFitMode) { const s = allProcessedSlots.find(r => r.utc === workDateUTC_MS); if (s) { renderTile(s, sc, true); sw.style.display = 'block'; } } else sw.style.display = 'none';
    }

    function syncAndRender(uM) { workDateUTC_MS = uM; isFitMode = true; const rV = document.getElementById('inputTz').value; let dD = (rV === 'local') ? new Date(uM) : new Date(uM + (parseFloat(rV) * 3600000)); document.getElementById('hourVal').value = dD.getUTCHours(); document.getElementById('minVal').value = dD.getUTCMinutes() >= 30 ? "30" : "00"; render(); buildMatchChart(); }
    function render() {
        const rM = isFitMode ? workDateUTC_MS : Date.now(), c = document.getElementById('member-groups'); if (c) { c.innerHTML = ''; if (Object.keys(locationData).length === 0) { c.innerHTML = `<div style="padding:20px; text-align:center; opacity:0.6; color:#94A3B8;">Add a city above.</div>`; } else { const gs = {}; Object.keys(locationData).forEach(n => { const d = locationData[n], k = `${d.tz}_${d.offset}`; if(!gs[k]) gs[k] = { label: d.tz, offset: d.offset, cities: [] }; gs[k].cities.push(n); }); Object.keys(gs).sort((a,b) => gs[b].offset - gs[a].offset).forEach(k => { const g = gs[k], l = new Date(rM + (g.offset * 3600000)), ds = l.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', timeZone: 'UTC' }), ts = l.getUTCHours().toString().padStart(2,'0') + ":" + l.getUTCMinutes().toString().padStart(2,'0'); let tH = `<div class="timezone-group"><div class="tz-header"><span>${g.label} (${g.offset >= 0 ? '+' : ''}${g.offset})</span><span>${ds} ${ts}</span></div>`; g.cities.forEach(loc => { const ms = team.filter(m => m.loc === loc); tH += `<div class="location-card"><div class="loc-header"><span>${loc}</span><span class="btn-hover-del" onclick="removeLocation('${loc}')">√ó</span></div>`; ms.forEach(m => { const s = getStatus(rM + (locationData[loc].offset * 3600000), 0); tH += `<div class="member-row"><div><span class="status-dot" style="background:${s.color}"></span><span>${m.name}</span></div><div>${s.emoji}<span class="btn-hover-del" onclick="removeMember('${m.id}')">√ó</span></div></div>`; }); tH += `</div>`; }); c.innerHTML += tH + `</div>`; }); } } drawMap(rM);
    }

    function addNL(x, t, c, p) { const g = document.createElementNS("http://www.w3.org/2000/svg", "g"), l = document.createElementNS("http://www.w3.org/2000/svg", "line"), tx = document.createElementNS("http://www.w3.org/2000/svg", "text"); l.setAttribute("x1", x); l.setAttribute("y1", 5); l.setAttribute("x2", x); l.setAttribute("y2", 400); l.setAttribute("class", "grid-line"); tx.setAttribute("x", x+5); tx.setAttribute("y", 20); tx.setAttribute("fill", c); tx.setAttribute("class", "map-label-text"); tx.textContent = t; g.appendChild(l); g.appendChild(tx); p.appendChild(g); }
    function drawMap(rM) { const n = document.getElementById('day-night-layer'), lb = document.getElementById('grid-label-layer'), mk = document.getElementById('marker-layer'); n.innerHTML = lb.innerHTML = mk.innerHTML = ''; const uH = new Date(rM).getUTCHours() + new Date(rM).getUTCMinutes()/60; for(let i=0; i<24; i++) { const ln = (i*15)-180; const x = (ln+180)*2.222; const hI = Math.floor((24+uH+(ln/15))%24); if (hI < 6 || hI >= 18) { const r = document.createElementNS("http://www.w3.org/2000/svg", "rect"); r.setAttribute("x", x); r.setAttribute("width", 33.4); r.setAttribute("height", 400); r.setAttribute("fill", "var(--night-wash)"); n.appendChild(r); } if (hI === 9) addNL(x, "START", "var(--accent-secondary)", lb); else if (hI === 17) addNL(x, "END", "var(--accent-secondary)", lb); } Object.values(locationData).forEach(d => { const px = (d.lon + 180) * 2.222, py = (90 - d.lat) * 2.222, dt = document.createElementNS("http://www.w3.org/2000/svg", "circle"); dt.setAttribute("cx", px); dt.setAttribute("cy", py); dt.setAttribute("r", 4); dt.setAttribute("fill", "white"); dt.setAttribute("stroke", "black"); mk.appendChild(dt); const tx = document.createElementNS("http://www.w3.org/2000/svg", "text"); tx.setAttribute("x", px + 6); tx.setAttribute("y", py + 3); tx.setAttribute("class", "pin-lbl"); tx.textContent = d.code; mk.appendChild(tx); }); }
    function setFitMode(v) { const h = parseInt(document.getElementById('hourVal').value) || 0, dS = document.getElementById('schedDate').value, rV = document.getElementById('inputTz').value; workDateUTC_MS = (rV === 'local') ? new Date(dS + "T" + h.toString().padStart(2,'0') + ":00").getTime() : (new Date(dS + "T" + h.toString().padStart(2,'0') + ":00Z").getTime() - parseFloat(rV)*3600000); isFitMode = v; if(isMatchViewActive) buildMatchChart(); else render(); }
    function resetToLive() { document.getElementById('schedDate').valueAsDate = new Date(); document.getElementById('hourVal').value = ""; document.getElementById('minVal').value = "00"; workDateUTC_MS = Date.now(); isFitMode = false; if(isMatchViewActive) buildMatchChart(); else render(); }
    function closeModal() { document.getElementById('city-modal').style.display = 'none'; }
    checkSession(); document.getElementById('schedDate').valueAsDate = new Date();
</script>
</body>
</html>

```
